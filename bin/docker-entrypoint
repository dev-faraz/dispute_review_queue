#!/bin/bash
set -e


echo "Installing TailwindCSS + Importmap (only once)..."

# Install Importmap (skip if already exists)
if ! grep -q "importmap" config/importmap.rb 2>/dev/null; then
  echo "Installing Importmap..."
  bundle exec rails importmap:install << 'EOF'
n
EOF
else
  echo "Importmap already installed"
fi

# Install TailwindCSS (skip if already exists)
if ! grep -q "tailwind" app/assets/stylesheets/application.tailwind.css 2>/dev/null; then
  echo "Installing TailwindCSS..."
  bundle exec rails tailwindcss:install << 'EOF'
n
EOF
else
  echo "TailwindCSS already installed"
fi


until pg_isready -h db -p 5432 -U postgres; do
  echo "Waiting for PostgreSQL..."
  sleep 2
done


echo "PostgreSQL is up — running Rails setup..."

if ! bundle exec rails runner "ActiveRecord::Base.connection" 2>/dev/null; then
  echo "Database doesn't exist or is empty — running setup..."
  bundle exec rails db:create db:schema:load
  bundle exec rails db:seed
else
  echo "Database exists — running migrations..."
  bundle exec rails db:migrate
  bundle exec rails db:seed
fi

echo "Setup complete! Starting app..."

exec "$@"